<!DOCTYPE html>
<html>
<head>
<title><!--(bake /data/name_test.txt _if="test")--><!--(bake /data/name_release.txt _if="!test")--></title>
<meta charset="utf-8">
<style>
body
{
	font: 10pt Cousine, monospace;
	margin: 2em auto;
	width: 600px;
}

h1
{
	font-size: 14pt;
	text-align: center;
	margin-bottom: 1em;
}

h2
{
	font-size: 12pt;
	text-align: center;
	margin-bottom: 1.5em;
}

tw-storydata
{
	display: block !important;
}

tw-passagedata
{
	display: block !important;
	line-height: 200%;
	margin-bottom: 2em;
	white-space: pre-wrap;
	position: relative;
}

tw-passagedata + tw-passagedata
{
	border-top: 1pt dashed black;
	/*padding-top: 2em;*/
}

/*
tw-passagedata:before
{
	content: attr(name);
	display: block;
	font-weight: bold;
}
*/
span.character-name {
	display: block;
    margin-left: 200px;
	text-transform: uppercase;
}
span.character-line {
	display: block;
    margin-left: 100px;
}
.hidden {
	display: none !important;
}
.alternate {
	color: red;
}
span.sequence-id {
	display: block;
    position: absolute;
    left: -100px;
    font-size: 14pt;
}
</style>
<script>
var tag;
var originalPassages = [];
var containerEl;
var tagLabelEl;

const charNameRE = /(\w*):\s*(.*)\n/g;
const choiceRE = /\[\[.*\]\]/g;
const dupeNewlineRE = /\n+/g;
function processPassage(passage, p, tag) {
	var html = passage.innerHTML;
	html = html.replaceAll(charNameRE, "<span class='character-name'>$1</span><span class='character-line'>$2</span>");
	html = html.replaceAll(choiceRE, "");
	html = html.replaceAll(dupeNewlineRE, "\n");
	html = "<span class='sequence-id'>#" + tag + p + "</span>" + html;
	var processedPassage = passage.cloneNode(true);
	processedPassage.innerHTML = html;
	return processedPassage;
}

function showRun(tag, saveOriginals) {
	tagLabelEl.innerText = "Run " + tag;

	var passages = document.getElementsByTagName("tw-passagedata");
	for (var p = passages.length-1; p >= 0 ; p--) {
		var passage = passages[p];
		if (saveOriginals) {
			originalPassages[p] = passage.cloneNode(true);
		}
		passage.remove();
	}
	var seq = 1;
	for (var p = 0 ; p < originalPassages.length ; p++) {
		var passage = originalPassages[p];
		var tags = passage.getAttribute("tags");
		var processedPassage = processPassage(passage, seq, tag);
		if (tags.split(' ').indexOf(tag) >= 0) {
			seq++;
			containerEl.appendChild(processedPassage);
		}
	}
}

function onTagSelectChange(event) {
	tag = event.target.value;
	showRun(tag);
}

window.onload = function() {
	tag = "A";
	containerEl = document.getElementsByTagName("tw-storydata")[0];
	tagLabelEl = document.createElement("h2");
	containerEl.appendChild(tagLabelEl);

	showRun(tag, true);

	var selectControl = document.getElementById("tag-select");
	selectControl.addEventListener('change', onTagSelectChange);

}
</script>
</head>

<body>

<label for="tag-select">Choose a run:</label>
<select name="runs" id="tag-select">
	<option value="A">A</option>
	<option value="B">B</option>
</select>

<h1><!--(bake /data/name_crackernuts.txt _if="test")--><!--(bake /data/name_release.txt _if="!test")--></h1>

<!--(bake /data/passages_crackernuts.html _if="test")--><!--(bake /data/passages_release.html _if="!test")-->

</body>
</html>
