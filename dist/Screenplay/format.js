window.storyFormat({"name":"Screenplay","version":"0.2.4","description":"A story format that resembles a screenplay. Uses tags to show specific run-throughs which actors can more easily digest. Icon by DARAYANI from <a href=\"https://thenounproject.com/browse/icons/term/screenplay/\">Noun Project</a> (CC BY 3.0)","author":"Joe Bain","image":"icon.svg","url":"http://hairyheart.games","license":"ZLib/Libpng","proofing":true,"source":"<!DOCTYPE html>\r\n<html>\r\n<head>\r\n<title>{{STORY_NAME}}\r\n</title>\r\n<meta charset=\"utf-8\">\r\n<style>\r\nbody\r\n{\r\n\tfont: 10pt Cousine, monospace;\r\n}\r\n\r\nh1\r\n{\r\n\tfont-size: 14pt;\r\n\ttext-align: center;\r\n\tmargin-bottom: 1em;\r\n}\r\n\r\nh2\r\n{\r\n\tfont-size: 12pt;\r\n\ttext-align: center;\r\n\tmargin-bottom: 1.5em;\r\n}\r\n\r\ntw-storydata\r\n{\r\n\tdisplay: block !important;\r\n\tmargin: 2em auto;\r\n\twidth: 550px;\r\n}\r\n\r\ntw-passagedata\r\n{\r\n\tdisplay: block !important;\r\n\tline-height: 200%;\r\n\tmargin-bottom: 2em;\r\n\twhite-space: pre-wrap;\r\n\tposition: relative;\r\n}\r\n\r\ntw-passagedata + tw-passagedata\r\n{\r\n\tborder-top: 1pt dashed black;\r\n\t/*padding-top: 2em;*/\r\n}\r\n\r\n/*\r\ntw-passagedata:before\r\n{\r\n\tcontent: attr(name);\r\n\tdisplay: block;\r\n\tfont-weight: bold;\r\n}\r\n*/\r\nspan.character-name {\r\n\tdisplay: block;\r\n    margin-left: 200px;\r\n\ttext-transform: uppercase;\r\n}\r\nspan.character-line {\r\n\tdisplay: block;\r\n    margin-left: 100px;\r\n}\r\n.hidden {\r\n\tdisplay: none !important;\r\n}\r\n.alternate {\r\n\tcolor: red;\r\n}\r\nspan.sequence-id {\r\n\tdisplay: block;\r\n    position: absolute;\r\n    left: -70px;\r\n    font-size: 20px;\r\n}\r\nspan.option-label {\r\n    display: block;\r\n    text-align: right;\r\n    font-style: italic;\r\n    height: 0;\r\n}\r\n@media print\r\n{    \r\n    .no-print, .no-print *\r\n    {\r\n\t        display: none !important;\r\n    }\r\n}\r\ntw-passagedata[tags=\"B\"] {\r\n    color: blue;\r\n}\r\ntw-passagedata[tags=\"C\"] {\r\n    color: red;\r\n}\r\n</style>\r\n<script>\r\nvar selectedTags = [];\r\nvar passagesById = [];\r\nvar passagesByName = [];\r\nvar positions = [];\r\nvar outputPassages = [];\r\nvar containerEl;\r\nvar tagLabelEl;\r\n\r\nconst charNameRE = /([^\\n:]+): *([^\\n]{3,})\\n/g;\r\nconst choiceRE = /\\[\\[(.*)\\]\\]/g;\r\nconst dupeNewlineRE = /\\n{2,}/g;\r\nfunction processPassage(passage, id, branchNum) {\r\n\tvar baseHtml = passage.innerHTML;\r\n    var html = \"\";\r\n\r\n    var match;\r\n    var prevMatchIndex = 0;\r\n    var n = 0;\r\n    do {\r\n        match = choiceRE.exec(baseHtml);\r\n        if (match) {\r\n            var name = match[1];\r\n            if (name in passagesByName) {\r\n                var _passage = passagesByName[name];\r\n                html += baseHtml.slice(prevMatchIndex, match.index) + \"<span class='option-label'>[Option => \" + _passage.id + \"]</span><b>\" + name + \"</b>\";\r\n                prevMatchIndex = match.index+match[0].length;\r\n            }\r\n        }\r\n    } while (match);\r\n    html += baseHtml.slice(prevMatchIndex);\r\n\r\n\thtml = html.replaceAll(charNameRE, \"<span class='character-name'>$1</span><span class='character-line'>$2</span>\");\r\n\thtml = html.replaceAll(dupeNewlineRE, \"\\n\\n\");\r\n\thtml = \"<span class='sequence-id'>#\" + id + \"</span>\" + html;\r\n\r\n\tvar processedPassage = passage.cloneNode(true);\r\n\tprocessedPassage.innerHTML = html;\r\n\treturn processedPassage;\r\n}\r\n\r\nfunction addPassage(passage, seq, visited) {\r\n    if (visited.indexOf(passage.pid) >= 0) return;\r\n\r\n    visited.push(passage.pid);\r\n\r\n    var tags = passage.tags;\r\n\r\n    for (var t = 0; t < selectedTags.length ; t++) {\r\n        var tag = selectedTags[t];\r\n        if (tags.indexOf(tag) >= 0) {\r\n            outputPassages.push(passage);\r\n            break;\r\n        }\r\n    }\r\n\r\n\r\n    for (var p = 0 ; p < passage.next.length ; p++) {\r\n        addPassage(passage.next[p], seq, visited);\r\n    }\r\n}\r\n\r\nfunction showRun(saveOriginals) {\r\n\ttagLabelEl.innerText = \"Run \" + selectedTags.join('/');\r\n\r\n    var story = document.getElementsByTagName(\"tw-storydata\")[0];\r\n    var startPid = story.getAttribute(\"startnode\");\r\n\r\n\tvar passages = document.getElementsByTagName(\"tw-passagedata\");\r\n    if (saveOriginals) {\r\n        positions = [];\r\n        for (var p = passages.length-1; p >= 0 ; p--) {\r\n            var passage = passages[p];\r\n            var yPos = parseInt(passage.getAttribute(\"position\").split(',')[1]);\r\n            if (positions.indexOf(yPos) == -1) {\r\n                positions.push(yPos);\r\n            }\r\n        }\r\n        positions.sort((a,b) => a-b);\r\n    }\r\n\tfor (var p = passages.length-1; p >= 0 ; p--) {\r\n\t\tvar passage = passages[p];\r\n\t\tif (saveOriginals) {\r\n            var pid = passage.getAttribute(\"pid\");\r\n            var name = passage.getAttribute(\"name\");\r\n            var tags = passage.getAttribute(\"tags\").split(' ');\r\n            var yPos = parseInt(passage.getAttribute(\"position\").split(',')[1]);\r\n            var vertIndex = positions.indexOf(yPos);\r\n            var passageData =  {\r\n                passage: passage.cloneNode(true),\r\n                pid: pid,\r\n                id: tags.join('') + vertIndex,\r\n                vertIndex: vertIndex,\r\n                name: name,\r\n                tags: tags,\r\n                next: []\r\n            };\r\n            passagesById[pid] = passageData;\r\n            passagesByName[name] = passageData;\r\n\t\t}\r\n\t\tpassage.remove();\r\n\t}\r\n    if (saveOriginals) {\r\n        for (var p in passagesById) {\r\n            var passage = passagesById[p];\r\n            var text = passage.passage.innerHTML;\r\n            var match;\r\n            do {\r\n                match = choiceRE.exec(text)\r\n                if (match) {\r\n                    var name = match[1];\r\n                    if (name in passagesByName) {\r\n                        passage.next.push(passagesByName[name]);\r\n                    }\r\n                }\r\n            } while (match);\r\n        }\r\n        for (var p in passagesById) {\r\n            var passage = passagesById[p];\r\n            passage.html = processPassage(passage.passage, passage.id);\r\n        }\r\n    }\r\n\r\n    outputPassages = [];\r\n    addPassage(passagesById[startPid], 1, []);\r\n    outputPassages.sort((a, b) => a.vertIndex - b.vertIndex);\r\n\tfor (var p = 0 ; p < outputPassages.length ; p++) {\r\n\t\tvar passage = outputPassages[p];\r\n        containerEl.appendChild(passage.html);\r\n\t}\r\n}\r\n\r\nfunction onTagSelectChange(event) {\r\n    selectedTags = [];\r\n    for (var t = 0; t < event.target.selectedOptions.length ; t++) {\r\n        selectedTags.push(event.target.selectedOptions[t].value);\r\n    }\r\n\tshowRun();\r\n}\r\n\r\nfunction populateTags() {\r\n    var tags = document.getElementsByTagName(\"tw-tag\");\r\n\tvar selectControl = document.getElementById(\"tag-select\");\r\n    var first = true;\r\n    for (var t = 0; t < tags.length; t++) {\r\n        var tagData = tags[t];\r\n        var option = document.createElement(\"option\");\r\n        var name = tagData.getAttribute(\"name\");\r\n        option.value = option.innerText = name;\r\n        if (first) {\r\n            option.setAttribute(\"selected\", true);\r\n            tag = name;\r\n            first = false;\r\n        }\r\n        selectControl.appendChild(option);\r\n    }\r\n\tselectControl.addEventListener('change', onTagSelectChange);\r\n}\r\n\r\nwindow.onload = function() {\r\n    populateTags();\r\n\tcontainerEl = document.getElementsByTagName(\"tw-storydata\")[0];\r\n\ttagLabelEl = document.createElement(\"h2\");\r\n\tcontainerEl.appendChild(tagLabelEl);\r\n\r\n    selectedTags = [\"A\"];\r\n\tshowRun(true);\r\n\r\n\r\n}\r\n</script>\r\n</head>\r\n\r\n<body>\r\n\r\n<div class=\"no-print\">\r\n<label for=\"tag-select\">Choose a run:</label>\r\n<select name=\"runs\" id=\"tag-select\" multiple>\r\n</select>\r\n</div>\r\n\r\n<h1>{{STORY_NAME}}\r\n</h1>\r\n\r{{STORY_DATA}}\r\n\r\n\r\n</body>\r\n</html>\r\n"});